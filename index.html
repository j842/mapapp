<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Map Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        #map {
            height: 600px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .image-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            cursor: pointer;
        }

        .image-popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90vh;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .image-popup img {
            max-width: 100%;
            max-height: 70vh;
            display: block;
            margin: 0 auto;
        }

        .image-popup .notes {
            margin-top: 15px;
            color: #2c3e50;
            font-size: 16px;
            line-height: 1.5;
        }

        .thumbnail-marker {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .thumbnail-marker:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .custom-icon {
            background: none;
            border: none;
        }

        .custom-icon img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .location-marker {
            width: 8px;
            height: 8px;
            background-color: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .arrow-line {
            stroke: #e74c3c;
            stroke-width: 2;
            stroke-linecap: round;
        }

        .arrow-head {
            fill: #e74c3c;
        }

        .coordinates-popup {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .coordinates-popup button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
        }

        .coordinates-popup button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="page-title">Loading...</h1>
        <div id="map"></div>
    </div>

    <div id="image-popup" class="image-popup">
        <div class="image-popup-content">
            <img id="popup-image" src="" alt="Trail Image">
            <div id="popup-notes" class="notes"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let settings;
        let coordinatesPopup;

        // Function to calculate offset coordinates
        function getOffsetCoordinates(coords, trailPath, existingMarkers = []) {
            // Find the closest point on the trail
            let minDist = Infinity;
            let closestIndex = 0;
            
            for (let i = 0; i < trailPath.length - 1; i++) {
                const dist = getDistanceToLine(coords, trailPath[i], trailPath[i + 1]);
                if (dist < minDist) {
                    minDist = dist;
                    closestIndex = i;
                }
            }

            // Calculate the overall direction using 5% of the trail length
            const trailLength = trailPath.length;
            const segmentCount = Math.max(1, Math.floor(trailLength * 0.05)); // 5% of trail length
            let dx = 0, dy = 0;
            let count = 0;

            // Look at segments before and after the closest point
            const startIndex = Math.max(0, closestIndex - Math.floor(segmentCount / 2));
            const endIndex = Math.min(trailLength - 1, startIndex + segmentCount);

            for (let i = startIndex; i < endIndex; i++) {
                dx += trailPath[i + 1][1] - trailPath[i][1];
                dy += trailPath[i + 1][0] - trailPath[i][0];
                count++;
            }

            // Calculate average direction vector
            dx /= count;
            dy /= count;
            const length = Math.sqrt(dx * dx + dy * dy);

            // Normalize the direction vector
            const nx = dx / length;
            const ny = dy / length;

            // Calculate perpendicular vector (rotate 90 degrees)
            const px = -ny;
            const py = nx;

            // Base offset distance (approximately 50 meters)
            const baseOffset = 0.0005;

            // Try different offset positions until we find one that doesn't overlap
            for (let offset = 0; offset < 5; offset++) {
                const testCoords = [
                    coords[0] + py * baseOffset * (offset + 1),
                    coords[1] + px * baseOffset * (offset + 1)
                ];

                // Check if this position overlaps with any existing markers
                let overlaps = false;
                for (const marker of existingMarkers) {
                    const dist = getDistanceToLine(testCoords, marker.coords, marker.coords);
                    if (dist < 0.0003) { // Approximately 30 meters minimum distance
                        overlaps = true;
                        break;
                    }
                }

                if (!overlaps) {
                    return testCoords;
                }
            }

            // If we couldn't find a non-overlapping position, return the base offset
            return [
                coords[0] + py * baseOffset,
                coords[1] + px * baseOffset
            ];
        }

        // Function to calculate distance from point to line segment
        function getDistanceToLine(point, lineStart, lineEnd) {
            const dx = lineEnd[1] - lineStart[1];
            const dy = lineEnd[0] - lineStart[0];
            const length = Math.sqrt(dx * dx + dy * dy);

            if (length === 0) {
                return Math.sqrt(
                    Math.pow(point[0] - lineStart[0], 2) +
                    Math.pow(point[1] - lineStart[1], 2)
                );
            }

            const t = ((point[0] - lineStart[0]) * dy + (point[1] - lineStart[1]) * dx) / (length * length);
            
            if (t < 0) {
                return Math.sqrt(
                    Math.pow(point[0] - lineStart[0], 2) +
                    Math.pow(point[1] - lineStart[1], 2)
                );
            }
            
            if (t > 1) {
                return Math.sqrt(
                    Math.pow(point[0] - lineEnd[0], 2) +
                    Math.pow(point[1] - lineEnd[1], 2)
                );
            }

            const projection = [
                lineStart[0] + t * dy,
                lineStart[1] + t * dx
            ];

            return Math.sqrt(
                Math.pow(point[0] - projection[0], 2) +
                Math.pow(point[1] - projection[1], 2)
            );
        }

        // Function to create SVG arrow
        function createArrow(start, end) {
            const dx = end[1] - start[1];
            const dy = end[0] - start[0];
            const angle = Math.atan2(dy, dx);
            
            return {
                line: [start, end],
                angle: angle * 180 / Math.PI
            };
        }

        // Function to parse GPX file
        async function parseGPX(gpxText) {
            const parser = new DOMParser();
            const gpxDoc = parser.parseFromString(gpxText, 'text/xml');
            const trackPoints = gpxDoc.getElementsByTagName('trkpt');
            
            // Extract coordinates from GPX
            const trailPath = Array.from(trackPoints).map(point => [
                parseFloat(point.getAttribute('lat')),
                parseFloat(point.getAttribute('lon'))
            ]);

            return {
                title: gpxDoc.getElementsByTagName('name')[0]?.textContent || 'Trail Map',
                trailPath: trailPath
            };
        }

        // Function to load settings from JSON and GPX files
        async function loadSettings() {
            try {
                let settings = {
                    title: 'Trail Map',
                    trailPath: [],
                    images: []
                };

                // Try to load GPX file for trail path
                const gpxResponse = await fetch('data/trail.gpx');
                if (gpxResponse.ok) {
                    const gpxText = await gpxResponse.text();
                    const gpxData = await parseGPX(gpxText);
                    settings.trailPath = gpxData.trailPath;
                    settings.title = gpxData.title;
                }

                // Try to load JSON file for images and title (if no GPX title)
                const jsonResponse = await fetch('data/walk_settings.json');
                if (jsonResponse.ok) {
                    const jsonData = await jsonResponse.json();
                    settings.images = jsonData.images || [];
                    // Only use JSON title if we don't have a GPX title
                    if (!settings.trailPath.length) {
                        settings.title = jsonData.title;
                    }
                }

                // Validate that we have at least a trail path
                if (!settings.trailPath.length) {
                    throw new Error('No trail path found in either GPX or JSON file');
                }

                return settings;
            } catch (error) {
                console.error('Error loading settings:', error);
                throw error;
            }
        }

        // Function to format coordinates
        function formatCoordinates(lat, lng) {
            return `[${lat.toFixed(6)}, ${lng.toFixed(6)}]`;
        }

        // Function to copy coordinates to clipboard
        function copyCoordinates(lat, lng) {
            const coords = formatCoordinates(lat, lng);
            navigator.clipboard.writeText(coords).then(() => {
                const button = coordinatesPopup.getElement().querySelector('button');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        // Function to show coordinates popup
        function showCoordinatesPopup(e) {
            const coords = formatCoordinates(e.latlng.lat, e.latlng.lng);
            const content = `
                <div class="coordinates-popup">
                    <div>${coords}</div>
                    <button onclick="copyCoordinates(${e.latlng.lat}, ${e.latlng.lng})">Copy coordinates</button>
                </div>
            `;
            
            if (coordinatesPopup) {
                coordinatesPopup.setLatLng(e.latlng);
                coordinatesPopup.setContent(content);
            } else {
                coordinatesPopup = L.popup()
                    .setLatLng(e.latlng)
                    .setContent(content)
                    .addTo(map);
            }
        }

        // Initialize the map and load settings
        async function initialize() {
            try {
                settings = await loadSettings();
                
                document.getElementById('page-title').textContent = settings.title;
                
                // Create the map
                map = L.map('map');
                
                // Define map layers
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                });

                const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    attribution: '© Google'
                });

                const hybridLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    attribution: '© Google'
                });

                // Add layer control
                const baseMaps = {
                    "OpenStreetMap": osmLayer,
                    "Satellite": satelliteLayer,
                    "Hybrid": hybridLayer
                };

                // Add default layer (hybrid)
                hybridLayer.addTo(map);

                // Add layer control to map
                L.control.layers(baseMaps, null, {
                    collapsed: false
                }).addTo(map);

                // Draw the trail path
                const trailLine = L.polyline(settings.trailPath, {
                    color: '#3498db',
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);

                // Add right-click handler for coordinates
                map.on('contextmenu', function(e) {
                    const coords = formatCoordinates(e.latlng.lat, e.latlng.lng);
                    const content = `
                        <div class="coordinates-popup">
                            <div>${coords}</div>
                            <button onclick="copyCoordinates(${e.latlng.lat}, ${e.latlng.lng})">Copy coordinates</button>
                        </div>
                    `;
                    
                    if (coordinatesPopup) {
                        coordinatesPopup.remove();
                    }
                    
                    coordinatesPopup = L.popup()
                        .setLatLng(e.latlng)
                        .setContent(content)
                        .addTo(map);
                });

                // Calculate bounds from the trail path coordinates
                const bounds = L.latLngBounds(settings.trailPath);
                
                // Add 20% buffer to the bounds
                const bufferedBounds = bounds.pad(0.2);
                
                // Fit the map to the buffered bounds
                map.fitBounds(bufferedBounds);

                // Only add image markers if we have images in the settings
                if (settings.images && settings.images.length > 0) {
                    // Keep track of existing markers to prevent overlaps
                    const existingMarkers = [];

                    settings.images.forEach(image => {
                        // Calculate offset coordinates to avoid overlapping with trail and other markers
                        const offsetCoords = getOffsetCoordinates(image.coordinates, settings.trailPath, existingMarkers);
                        
                        // Add this marker to the list of existing markers
                        existingMarkers.push({
                            coords: offsetCoords
                        });
                        
                        // Create custom icon for thumbnail
                        const thumbnailIcon = L.divIcon({
                            className: 'custom-icon',
                            html: `<img src="data/images/${image.imageName}" alt="Trail Image">`,
                            iconSize: [50, 50],
                            iconAnchor: [25, 25]
                        });

                        // Create marker for thumbnail
                        const thumbnailMarker = L.marker(offsetCoords, { icon: thumbnailIcon });
                        
                        // Create marker for actual location
                        const locationMarker = L.marker(image.coordinates, {
                            icon: L.divIcon({
                                className: 'location-marker',
                                iconSize: [12, 12],
                                iconAnchor: [6, 6]
                            })
                        });

                        // Create line from thumbnail to location
                        const connectionLine = L.polyline([offsetCoords, image.coordinates], {
                            color: '#e74c3c',
                            weight: 2,
                            opacity: 0.8
                        });
                        
                        // Add click handler to thumbnail
                        thumbnailMarker.on('click', () => showImagePopup(image));
                        
                        // Add all elements to the map
                        locationMarker.addTo(map);
                        connectionLine.addTo(map);
                        thumbnailMarker.addTo(map);
                    });
                }
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        function showImagePopup(image) {
            const popup = document.getElementById('image-popup');
            const popupImage = document.getElementById('popup-image');
            const popupNotes = document.getElementById('popup-notes');
            
            popupImage.src = `data/images/${image.imageName}`;
            popupNotes.textContent = image.notes;
            popup.style.display = 'block';
        }

        // Close popup when clicking anywhere
        document.getElementById('image-popup').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Initialize when the page loads
        window.addEventListener('load', initialize);
    </script>
</body>
</html> 